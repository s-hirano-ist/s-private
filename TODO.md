# DDD改善タスク一覧

## 概要
DDDの原則に基づき、全ドメイン（articles, notes, images, books）の実装を改善する。

## 変更しない項目

### `UNEXPORTED`/`EXPORTED` の命名

- **理由**: 関係者間でこのドメインでの共通認識がすでにあるため

### ドメインサービスの命名改善
- **対象**:
  - `BooksDomainService` → `BookDuplicationChecker`
  - `NotesDomainService` → `NoteDuplicationChecker`
  - `ArticlesDomainService` → `ArticleDuplicationChecker`
- **理由**: 今後このファイルに追加のドメインサービスを追加予定であるため


### 値オブジェクトのディレクトリ分離
- **変更内容**: `src/domains/*/value-objects/`への分離
- **理由**: 可読性と1ファイルでのメリットが大きいため


## 2. 実装タスク（現実的優先度順）

### 🔥 Phase 0: 緊急度高・影響大（すぐに実施すべき）

#### 新規1: イベントシステムの初期化改善
- **現状**: リポジトリコンストラクタでイベントハンドラーを初期化
- **問題**: 関心事の分離不足、テスタビリティの低下
- **改善案**: アプリケーション起動時またはDIコンテナでの初期化
- **影響度**: 🟡 **中** - アーキテクチャ整合性

#### 新規2: イベントペイロード構造の一貫性
- **現状**: イベントペイロードに nullable/optional フィールドが混在
- **問題**: 型安全性の不足、実行時エラーのリスク
- **改善案**: 強い型付けとペイロード構造の統一
- **影響度**: 🟡 **中** - 型安全性


### 🟡 Phase 1: 基盤改善（中期実施・効果確実）

#### 4. ドメインサービスのインスタンス化の問題
- **現状**: アプリケーションサービスで直接インスタンス化（例：`addBooks.ts:18`）
- **問題**: テスタビリティの低下、依存関係の管理が分散
- **改善案**: DIコンテナまたはファクトリーパターンの導入
- **影響度**: 🟡 **中** - テスト容易性


#### 6. 集約の境界が不明確
- **現状**: エンティティが単体で存在、集約ルートが明確でない
- **問題**: トランザクション境界が不明瞭
- **改善案**: 集約の導入とトランザクション境界の明確化
- **影響度**: 🟠 **低** - 現在は問題顕在化せず


#### 8. トランザクション管理の不在
- **現状**: 明示的なトランザクション境界がない
- **問題**: 部分的な失敗時の整合性保証なし
- **改善案**: Unit of Workパターンの導入
- **影響度**: 🟠 **低** - 現在は単純なCRUD操作のみ

### 🔵 Phase 2: 基盤強化（中期実施・効果中程度）

#### 新規3: 集約設計の欠如
- **現状**: エンティティにビジネス振る舞いメソッドが不足
- **問題**: ドメインロジックがアプリケーションサービスに分散
- **改善案**: エンティティへのビジネスメソッド追加（`publish()`, `archive()`等）
- **影響度**: 🟠 **低** - 現在は問題顕在化せず

#### 新規4: 仕様パターンの未実装
- **現状**: ビジネスルールがドメインサービスに分散
- **問題**: 複雑な条件ロジックの再利用性不足
- **改善案**: 仕様オブジェクトによるビジネスルールの集約
- **影響度**: 🟠 **低** - 現在は単純なルールのみ

### 🔵 Phase 3: 上級パターン（将来検討・現在は不要）


#### タスク9: 集約ルートの実装
- **各ドメイン集約**: `*Aggregate`クラス群
- **集約リポジトリ**: 集約単位での永続化
- **理由**: 現在のエンティティ単位操作で十分
- **検討時期**: 複数エンティティの整合性管理が必要になった時点

#### タスク10: 仕様パターンの導入
- **ベース仕様**: `src/domains/common/specifications/specification.ts`
- **ドメイン固有仕様**: 複雑なビジネスルール表現
- **理由**: 現在のバリデーションロジックで充足
- **検討時期**: 複雑な条件分岐が増加した時点

#### タスク11: Unit of Workパターン
- **Unit of Work**: `src/infrastructures/persistence/unit-of-work.ts`
- **理由**: 現在は単一エンティティ操作中心
- **検討時期**: 複数テーブル横断処理が増加した時点

#### タスク12: CQRS・高度パターン
- **コマンド/クエリ分離**: アプリケーションサービス再構成
- **理由**: 現在の読み書き要求で十分
- **検討時期**: パフォーマンス要件が厳しくなった時点

## 3. 優先度別改善ロードマップ

### 3.1 短期改善（Phase 0-1：2-4週間）

#### 🔥 最優先タスク
1. **ドメインサービスのインスタンス化改善**
   - DIコンテナまたはファクトリーパターンの導入
   - テスタビリティとメンテナンス性の向上

2. **イベントシステム初期化の改善**
   - リポジトリから初期化責務を分離
   - 設定の一元化と関心事の分離

#### 🟡 重要度中
3. **ドメインサービス命名の改善**
   - 具体的な責務を表現する命名への変更
   - コードの意図明確化

4. **イベントペイロード構造統一**
   - 型安全性の向上
   - 実行時エラーの削減

### 3.2 中期改善（Phase 2：1-3ヶ月）

#### ⭕ アーキテクチャ強化
5. **値オブジェクトの分離**
   - ディレクトリ構造の整理
   - ドメインロジックの集約

6. **エンティティビジネスメソッド追加**
   - ドメインロジックのエンティティ集約
   - アプリケーションサービスの簡素化

### 3.3 長期改善（Phase 3：3ヶ月以降）

#### 🔵 高度パターン（必要時のみ）
7. **集約ルート導入**
   - トランザクション境界の明確化
   - データ整合性の強化

8. **仕様パターン実装**
   - 複雑ビジネスルールの表現力向上
   - ルールの再利用性強化

9. **Unit of Work パターン**
   - トランザクション管理の統一
   - データ整合性の保証強化

## 4. 実装スケジュール

### 🗓️ フェーズ0（即座に着手：1-2週間）
- [ ] ドメインサービスのDI化
- [ ] イベントハンドラー初期化の分離

### 🗓️ フェーズ1（短期：2-4週間）
- [ ] ドメインサービス命名改善
- [ ] イベントペイロード型安全性向上

### 🗓️ フェーズ2（中期：1-3ヶ月）
- [ ] 値オブジェクト分離
- [ ] エンティティビジネスメソッド拡充

## 5. 推奨される改善後のディレクトリ構造

```
src/
├── domains/                      # ドメイン層
│   ├── notes/
│   │   ├── aggregates/          # 集約
│   │   │   └── note.aggregate.ts
│   │   ├── entities/            # エンティティ
│   │   │   └── note.entity.ts
│   │   ├── value-objects/       # 値オブジェクト
│   │   │   ├── note-title.vo.ts
│   │   │   └── markdown.vo.ts
│   │   ├── repositories/        # リポジトリインターフェース
│   │   ├── services/            # ドメインサービス
│   │   ├── events/              # ドメインイベント
│   │   ├── factories/           # ファクトリー
│   │   └── specifications/      # 仕様オブジェクト
│   ├── articles/                # 同様の構造
│   ├── books/                   # 同様の構造
│   ├── images/                  # 同様の構造
│   └── common/                  # 共有ドメインオブジェクト
│       ├── events/
│       ├── specifications/
│       └── value-objects/
├── application-services/         # アプリケーション層
│   ├── notes/
│   │   ├── commands/            # コマンド（CQRSパターン）
│   │   ├── queries/             # クエリ（CQRSパターン）
│   │   └── handlers/            # イベントハンドラー
│   └── ...
├── infrastructures/              # インフラストラクチャ層
│   ├── persistence/             # 永続化
│   ├── di/                      # 依存性注入
│   └── events/                  # イベントバス実装
└── ...
```
