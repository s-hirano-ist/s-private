# DDD改善タスク一覧

## 概要
DDDの原則に基づき、全ドメイン（articles, notes, images, books）の実装を改善する。

## ✅ 実装済み項目（削除対象）

### 完了した改善
1. **リポジトリインターフェース**: 適切にコマンド/クエリ分離実装済み
2. **ドメインイベント基盤**: BaseDomainEventと一貫したイベント構造実装済み
3. **値オブジェクト実装**: Zod brandsを使用した型安全な実装済み

## 変更しない項目

### `UNEXPORTED`/`EXPORTED` の命名
- **理由**: 関係者間でこのドメインでの共通認識がすでにあるため

### ドメインサービスの命名
- **理由**: 今後このファイルに追加のドメインサービスを追加予定であるため


## 2. 実装タスク（現実的優先度順）

### 🔥 Phase 0: 緊急度高・影響大（すぐに実施すべき）

#### 1. ドメインサービスのインスタンス化の問題
- **現状**: アプリケーションサービスで直接インスタンス化（例：`new BooksDomainService()`）
- **問題**: テスタビリティの低下、依存関係の管理が分散、DIなし
- **改善案**: DIコンテナまたはファクトリーパターンの導入
- **影響度**: 🔴 **高** - テスト容易性とメンテナンス性

#### 2. イベントシステムの初期化改善
- **現状**: リポジトリコンストラクタでイベントハンドラーを初期化
- **問題**: 関心事の分離不足、単一責任原則違反
- **改善案**: アプリケーション起動時またはDIコンテナでの初期化
- **影響度**: 🔴 **高** - アーキテクチャ整合性

#### 3. イベントペイロード構造の一貫性
- **現状**: イベントペイロードに nullable/optional フィールドが混在
- **問題**: 型安全性の不足、実行時エラーのリスク
- **改善案**: 強い型付けとペイロード構造の統一
- **影響度**: 🟡 **中** - 型安全性

#### 新規4: 手続き的なドメインサービス
- **現状**: ドメインサービスがリポジトリの薄いラッパー
- **問題**: リッチなドメイン振る舞いの欠如、単なるデータアクセス層
- **改善案**: ビジネスロジックとルールをドメインサービスに集約
- **影響度**: 🔴 **高** - ドメイン表現力

#### 新規5: アプリケーションサービスの肥大化
- **現状**: ビジネスロジックとオーケストレーションが混在
- **問題**: 単一責任原則違反、テスト困難、保守性低下
- **改善案**: ビジネスロジックをドメイン層に移動、純粋なオーケストレーションに
- **影響度**: 🔴 **高** - メンテナンス性


### 🟡 Phase 1: 基盤改善（中期実施・効果確実）

#### 6. 貧血ドメインモデル
- **現状**: エンティティが純粋なデータ構造、ビジネスメソッドなし
- **問題**: ドメインロジックがアプリケーションサービスに分散
- **改善案**: エンティティに`publish()`, `archive()`, `validate()`等のビジネスメソッド追加
- **影響度**: 🟡 **中** - ドメイン表現力

#### 7. 集約の境界が不明確
- **現状**: エンティティが単体で存在、集約ルートが明確でない
- **問題**: トランザクション境界が不明瞭
- **改善案**: 集約の導入とトランザクション境界の明確化
- **影響度**: 🟠 **低** - 現在は問題顕在化せず

#### 8. トランザクション管理の不在
- **現状**: 明示的なトランザクション境界がない
- **問題**: 部分的な失敗時の整合性保証なし
- **改善案**: Unit of Workパターンの導入
- **影響度**: 🟠 **低** - 現在は単純なCRUD操作のみ

#### 新規9: イベントハンドラ登録の分散
- **現状**: 複数のリポジトリファイルから初期化呼び出し
- **問題**: 重複初期化、依存関係チェーンが不明瞭
- **改善案**: イベントハンドラ登録の一元管理
- **影響度**: 🟡 **中** - メンテナンス性

### 🔵 Phase 2: 基盤強化（中期実施・効果中程度）

#### 10. 仕様パターンの未実装
- **現状**: ビジネスルールがドメインサービスに埋め込まれている
- **問題**: 複雑な条件ロジックの再利用性不足、コンポジション不可
- **改善案**: 仕様オブジェクトによるビジネスルールの集約
- **影響度**: 🟠 **低** - 現在は単純なルールのみ

#### 新規11: ドメインロジックの漏洩
- **現状**: キャッシュタグ、フォームバリデーション、権限チェックが混在
- **問題**: インフラ関心事とドメインロジックの混在
- **改善案**: 関心事の適切な層への分離
- **影響度**: 🟡 **中** - アーキテクチャ整合性

#### 新規12: ファクトリーパターンの欠如
- **現状**: 複雑なエンティティ生成ロジックが分散
- **問題**: エンティティ生成の一貫性欠如
- **改善案**: ドメインファクトリーの導入
- **影響度**: 🟠 **低** - 現在は単純な生成ロジックのみ

### 🔵 Phase 3: 上級パターン（将来検討・現在は不要）

#### 13. 高度な集約ルートの実装
- **各ドメイン集約**: `*Aggregate`クラス群での複雑な整合性管理
- **集約リポジトリ**: 集約単位での永続化
- **理由**: 現在のエンティティ単位操作で十分
- **検討時期**: 複数エンティティの整合性管理が必要になった時点

#### 14. CQRS・イベントソーシング
- **コマンド/クエリ分離**: アプリケーションサービス再構成
- **イベントソーシング**: 監査証跡の強化
- **理由**: 現在の読み書き要求で十分
- **検討時期**: パフォーマンス要件が厳しくなった時点

## 3. 優先度別改善ロードマップ

### 3.1 短期改善（Phase 0：1-2週間）

#### 🔥 最優先タスク
1. **ドメインサービスのDI化**
   - DIコンテナまたはファクトリーパターンの導入
   - テスタビリティとメンテナンス性の向上

2. **イベントシステム初期化の改善**
   - リポジトリから初期化責務を分離
   - アプリケーション起動時の一元管理

3. **手続き的ドメインサービスの改善**
   - リッチなドメイン振る舞いの追加
   - ビジネスルールの集約

4. **アプリケーションサービスのリファクタリング**
   - ビジネスロジックをドメイン層へ移動
   - 純粋なオーケストレーションへ

### 3.2 中期改善（Phase 1-2：1-3ヶ月）

#### 🟡 アーキテクチャ改善
5. **貧血ドメインモデルの解消**
   - エンティティにビジネスメソッド追加
   - ドメインロジックの適切な配置

6. **イベントハンドラ登録の一元化**
   - 初期化処理の整理
   - 依存関係の明確化

7. **ドメインロジック漏洩の解消**
   - 関心事の適切な分離
   - 層の責務明確化

### 3.3 長期改善（Phase 3：3ヶ月以降）

#### 🔵 高度パターン（必要時のみ）
8. **集約とトランザクション境界**
   - 集約ルートの確立
   - Unit of Workパターン

9. **仕様パターン・ファクトリー**
   - ビジネスルールの再利用性向上
   - エンティティ生成の一貫性

10. **CQRS・イベントソーシング**
    - パフォーマンス最適化
    - 監査証跡の強化

## 4. 実装チェックリスト

### 🗓️ Phase 0（最優先：1-2週間）
- [ ] ドメインサービスのDI化またはファクトリーパターン導入
- [ ] イベントハンドラー初期化をアプリケーション起動時に移動
- [ ] ドメインサービスにリッチなビジネスロジック追加
- [ ] アプリケーションサービスからビジネスロジックを分離

### 🗓️ Phase 1（短期：2-4週間）
- [ ] エンティティにビジネスメソッド追加（publish, archive等）
- [ ] イベントペイロード型の統一と強化
- [ ] イベントハンドラ登録の一元管理

### 🗓️ Phase 2（中期：1-3ヶ月）
- [ ] ドメインロジック漏洩の解消（キャッシュ、権限等）
- [ ] 仕様パターンの導入検討
- [ ] ファクトリーパターンの実装
- [ ] 集約境界の明確化

## 5. 推奨される改善後のディレクトリ構造

```
src/
├── domains/                      # ドメイン層
│   ├── notes/
│   │   ├── aggregates/          # 集約
│   │   │   └── note.aggregate.ts
│   │   ├── entities/            # エンティティ
│   │   │   └── note.entity.ts
│   │   ├── value-objects/       # 値オブジェクト
│   │   │   ├── note-title.vo.ts
│   │   │   └── markdown.vo.ts
│   │   ├── repositories/        # リポジトリインターフェース
│   │   ├── services/            # ドメインサービス
│   │   ├── events/              # ドメインイベント
│   │   ├── factories/           # ファクトリー
│   │   └── specifications/      # 仕様オブジェクト
│   ├── articles/                # 同様の構造
│   ├── books/                   # 同様の構造
│   ├── images/                  # 同様の構造
│   └── common/                  # 共有ドメインオブジェクト
│       ├── events/
│       ├── specifications/
│       └── value-objects/
├── application-services/         # アプリケーション層
│   ├── notes/
│   │   ├── commands/            # コマンド（CQRSパターン）
│   │   ├── queries/             # クエリ（CQRSパターン）
│   │   └── handlers/            # イベントハンドラー
│   └── ...
├── infrastructures/              # インフラストラクチャ層
│   ├── persistence/             # 永続化
│   ├── di/                      # 依存性注入
│   └── events/                  # イベントバス実装
└── ...
```
